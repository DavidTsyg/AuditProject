---

- hosts: all
  remote_user: david
  tasks:      
    - name: Add the host
      add_host: >
            name: "{{ansible_default_ipv4.address}}"

    - name: Install openvpn and easy-rsa
      apt: pkg={{item}} update_cache=true cache_valid_time=3600
      sudo: True
      with_items:
        - openvpn
        - easy-rsa

    - name: Create openvpn-ca directory
      shell: make-cadir /openvpn-ca

    - name: Copy default files
      copy: src={{ item.src }} dest={{item.dst}}
      with_items:
        - { src: '/home/david/AuditProject/base.conf', dest: '/openvpn-ca'  }
        - { src: '/home/david/AuditProject/before.rules', dest: '/openvpn-ca'  }
        - { src: '/home/david/AuditProject/make_config.sh', dest: '/openvpn-ca'  }
        - { src: '/home/david/AuditProject/server.conf', dest: '/openvpn-ca'  }
        - { src: '/home/david/AuditProject/sysctl.conf', dest: '/openvpn-ca'  }
        - { src: '/home/david/AuditProject/ufw', dest: '/openvpn-ca'  }
        - { src: '/home/david/AuditProject/vars', dest: '/openvpn-ca'  }

    - name: Move to /openvpn-ca 
      chdir: /openvpn-ca

    - name: Source the vars
      shell: source vars

    - name: Clean the invironment
      shell: ./clean-all

    - name: Build certificate authority
      shell: ./build-ca < /openvpn-ca/build-ca_input
 
    - name: Build server certificate
      shell: ./buld-key-server server < build-key-server server
    - name: Source the vars  
      shell: source vars

    - name: Generate HMAC signature
      shell: ./build-key-pass client1{{ansible_default_ipv4.address}}

    - name: Move to the keys directory
      chdir: /openvpn-ca/keys

    - name: Copy the keys
      shell: cp ca.crt ca.key server.crt server.key ta.key dh2048.pem /etc/ope$
      sudo: True

    - name: Copy the server config
      copy: src=/openvpn-ca/server.conf dest=/etc/openvpn/server.conf
     
    - name: Make the changes needed
      replace:
      path: /etc/openvpn/server.conf
      regexp: 'port 1194'
      replace: 'port 443'
    - replace:
      path: /etc/openvpn/server.conf
      regexp: 'server 10.8.0.0 255.255.255.0'
      replace: 'server 10.8.{{ansible_default_ipv4.address[12:]}}.0 255.255.255.0'
     
    - name: Replace the sysctl.conf
      copy: src=/home/david/AuditProject/sysctl.conf dest=/etc/sysctl.conf

    - name: Copy before.rules
      copy: src=/home/david/AuditProject/before.rules /etc/ufw/before.rules
      
    - name: Change before.rules
      replace:
      path: /etc/ufw/before.rules
      regexp: '-A POSTROUTONG -s 10.8.0.0/8 -o ens33 -j MASQUERADE'
      replace: '-A POSTROUTONG -s 10.8.{{ansible_default_ipv4.address[12:]}}.0/8 -o ens33 -j MASQUERADE'

    - name: Copy the ufw
      copy: src=/home/david/AuditProject/ufw dest=/etc/default/ufw

    - name: Open the ports
      shell: ufw allow 443/udp
      sudo: True

    - name: Allow ssh
      shell: ufw allow OpenSSH
      sudo: True

    - name: disable ufw     
      shell: ufw disable
      sudo: True

    - name: enable ufw   
      shell: ufw enable
      sudo: True
 
    - name: Start the openvpn server
      shell: systemctl start openvpn@server
      sudo: True 
